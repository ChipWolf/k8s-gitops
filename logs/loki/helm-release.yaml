---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  annotations:
    fluxcd.io/automated: "false"
    fluxcd.io/ignore: "false"
    fluxcd.io/tag.loki: "semver:~v1."
    fluxcd.io/tag.promtail: "semver:~v1."
  name: loki
  namespace: logs
spec:
  chart:
    name: loki-stack
    repository: "https://grafana.github.io/loki/charts"
    version: 0.41.1
  releaseName: loki
  values:
    loki:
      config:
        auth_enabled: false
        distributor:
          ring:
            kvstore:
              store: memberlist
        ingester:
          chunk_idle_period: 5m
          chunk_retain_period: 30s
          lifecycler:
            final_sleep: 0s
            ring:
              kvstore:
                store: memberlist
              replication_factor: 1
        limits_config:
          enforce_metric_name: false
          reject_old_samples: true
          reject_old_samples_max_age: 168h
        memberlist:
          abort_if_cluster_join_fails: false
          bind_port: 7946
          join_members:
            - "loki-headless.logs.svc.cluster.local:7946"
        schema_config:
          configs:
            - from: "2020-05-15"
              index:
                period: 24h
                prefix: index_
              object_store: s3
              schema: v11
              store: boltdb-shipper
        server:
          http_listen_port: 3100
        storage_config:
          boltdb_shipper:
            active_index_directory: /data/loki/index
            cache_location: /data/loki/index_cache
            resync_interval: 5s
            shared_store: s3
      extraPorts:
        - name: loki-gossip-ring
          port: 7956
          protocol: TCP
          targetPort: 7946
      persistence:
        enabled: false
      podAnnotations:
        prometheus.io/port: http-metrics
        prometheus.io/scrape: "true"
      replicas: 3
      serviceMonitor:
        enabled: true
      tolerations:
        - key: arm
          operator: Exists
    promtail:
      extraScrapeConfigs:
        - job_name: syslog
          relabel_configs:
            - source_labels:
                - __syslog_message_hostname
              target_label: host
            - source_labels:
                - __syslog_message_app_name
              target_label: app
          syslog:
            label_structured_data: true
            labels:
              job: syslog
            listen_address: "0.0.0.0:1514"
      serviceMonitor:
        enabled: true
      syslogService:
        enabled: true
        loadBalancerIP: 172.16.1.120
        port: 1514
        type: LoadBalancer
      tolerations:
        - key: arm
          operator: Exists
  valuesFrom:
    - secretKeyRef:
        name: loki-helm-values
